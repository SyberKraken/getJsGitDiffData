<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body {
    margin: 0;
    background-color: black;
  }

  a {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    font-size: 20px;
    color: aliceblue;
  }
  .linkcontainer{
    margin-top: 0;
    padding:5px 20px 5px 20px ;
    background-color: darkslategray;
    width: 50vw;
    display: flex;
    justify-content: space-between;
    border-bottom-right-radius: 20px;
  }
  .fullwidthparent{
    width: 100vw;
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
  }
  rect{

  }
</style>
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<body>

  <div class = "fullwidthparent">
    <div class="linkcontainer">
      <a href="http://localhost:5500/minimalvisualization/htmlpage.html?file=10_d3.json">10</a>
      <a href="http://localhost:5500/minimalvisualization/htmlpage.html?file=20_d3.json">20</a>
      <a href="http://localhost:5500/minimalvisualization/htmlpage.html?file=30_d3.json">30</a>
      <a href="http://localhost:5500/minimalvisualization/htmlpage.html?file=50_d3.json">50</a>
      <a href="http://localhost:5500/minimalvisualization/htmlpage.html?file=100_d3.json">100</a>
    </div>
</div>
<div id="my_dataviz" style="width: 100%; height: 100vh;"></div>
<script>

   // set the dimensions and margins of the graph
  var margin = {top: 0, right: 0, bottom: 0, left: 0},
  width = 1920 - margin.left - margin.right,
  height = 1080 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // read json data
    let params = new Proxy(new URLSearchParams(window.location.search),{get:(searchParams, prop) => searchParams.get(prop),});
    let file_to_show = params.file;
    d3.json("http://localhost:5500/" + file_to_show, function(data) {

     // Give the data to this cluster layout:
let root = d3.hierarchy(data).sum(function(d){ return d.value}) // Here the size of each leave is given in the 'value' field in input data
let nr_of_rects = Number(file_to_show.split("_")[0])

let max = 0;
let min = 9999999999;
let count = 0
let mapper = (d) =>{
  if (d.data.value > max){max = d.data.value}
  if (d.data.value < min){min = d.data.value}
  count ++
}

let inc_count = 0
let inc_colour = (d) =>{
  inc_count++

  let perc = inc_count/count * 100

  var r, g, b = 0;
	if(perc < 50) {
		r = 150;
		g = Math.round(3.1 * perc);
	}
	else {
		g = 150;
		r = Math.round(310 - 3.10 * perc);
	}
	var h = r * 0x10000 + g * 0x100 + b * 0x1;
/*   console.log(perc)
  console.log(d.data.name, inc_count, '#' + ('000000' + h.toString(16)).slice(-6)) */

  return '#' + ('000000' + h.toString(16)).slice(-6);

}

let title_sizing = (d) =>{
  let width = recmapper.get((d.x0,d.y0))
  let name = d.data.name

  //console.log(d.data.name, width)
  //console.log(d)
  if (width > 300){ return "30px"}
  if (width > 200){
    if(name.length > 17){
      return "15px"
    }
    if (name.length > 10){
      return "17px"
    }
    return "23px"
  }
  else if (width > 150){
    if (name.length > 25){
      return "8px"
    }
    if (name.length > 20){
      return "11px"
    }
    if (name.length > 15){
      return "15px"
    }
    return "20px"
  }
  else if (width > 100){
    if (name.length < 15){
      return "20px"
    }
    return "10px"
  }
  else if (width > 50){
    return "7x"
  }
}


let full_name_linebreak = (d) =>{
  let name = d.data.group
  let firstpart = name.substring(0,name.length/2)
  let lastpart = name.substring(name.length/2,name.length)
  if (name.length > 20){
    return firstpart + "\n" + lastpart
  }

  return name
}

/* console.log(nr_of_rects) */
// Then d3.treemap computes the position of each element of the hierarchy
d3.treemap()
  .size([width, height])
  .paddingTop(0)
  .paddingRight(0)
  .paddingInner(0)
  .paddingOuter(0)
  .padding(0)
  (root)

// prepare a color scale
var color = d3.scaleOrdinal()
  .range([ "#402D54", "#D18975", "#8F0175", "#199073", "#880000", "#008800","#000088","#555555"])

// And an opacity scale
var opacity = d3.scaleLinear()
  .domain([0, 30])
  .range([.5,1])

let recmapper = new Map()
// use this information to add rectangles:
svg
  .selectAll("rect")
  .data(root.leaves())
  .enter()
  .append("rect")
    .attr('x', function (d) { recmapper.set((d.x0,d.y0),d.x1 - d.x0) ;return d.x0; })
    .attr('y', function (d) { mapper(d); return d.y0; })
    .attr('width', function (d) { return d.x1 - d.x0; })
    .attr('height', function (d) { return d.y1 - d.y0; })
    .style("stroke", "black")
    .style("fill", function(d){ return inc_colour(d)} )
    .style("opacity", function(d){ return opacity(d.data.value)})
    .attr("title", "TESTWORK")

// and to add the text labels
svg
  .selectAll("text")
  .data(root.leaves())
  .enter()
  .append("text")
    .attr("x", function(d){ return d.x0 +5})    // +10 to adjust position (more right)
    .attr("y", function(d){return d.y0 + 50})    // +20 to adjust position (lower)
    .text(function(d){ return d.data.name})
    .attr("font-size", function(d){return title_sizing(d)})
    .attr("font-family", "consolas")
    .attr("fill", "white")

// and to add the text labels
svg
  .selectAll("vals")
  .data(root.leaves())
  .enter()
  .append("text")
    .attr("x", function(d){ return d.x0+5})
    .attr("y", function(d){ return d.y0+15})
    .text(function(d){ return d.data.group })
    .attr("font-size", function(d){if(d.data.group.length > 20){return "2px"}else{return "10px"}})
    .attr("font-family", "consolas")
    .attr("fill", "white")

d3.selectAll("rect").on("click", function(d){
  //works
  var title = d.title;
  console.log(d.data.name);
});
// Add title for the 3 groups
/* svg
  .selectAll("titles")
  .data(root.descendants().filter(function(d){return d.depth==1}))
  .enter()
  .append("text")
    .attr("x", function(d){ return d.x0})
    .attr("y", function(d){ return d.y0+21})
    .text(function(d){ return d.data.name })
    .attr("font-size", "19px")
    .attr("fill",  function(d){ return color(d.data.name)} )
 */
// Add title for the 3 groups
/* svg
  .append("text")
    .attr("x", 0)
    .attr("y", 14)    // +20 to adjust position (lower)
    .text("Files")
    .attr("font-size", "19px")
    .attr("fill",  "grey" )
 */
})
</script>
</body>